name: Agendar Deploy (via issue)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag para deploy (ex: v1.8.0)"
        required: true
      data_local:
        description: "Data do deploy no formato local (DD-MM-YYYY)"
        required: true
        default: "07-11-2025"
      hora_local:
        description: "Hora do deploy no formato local (HH:mm)"
        required: true
        default: "20:30"
      fuso_horario:
        description: "Seu fuso hor치rio (ex: America/Sao_Paulo, America/New_York)"
        required: true
        default: "America/Sao_Paulo"

permissions:
  issues: write  # 游녣 Permite criar e editar issues
  contents: read # Leitura b치sica do reposit칩rio

jobs:
  criar_issue:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Converter data/hora local para UTC
        id: convert_time
        run: |
          # Reorganiza a data de DD-MM-YYYY para YYYY-MM-DD, que o comando `date` entende melhor.
          reformatted_date=$(echo "${{ inputs.data_local }}" | awk -F- '{print $3"-"$2"-"$1}')
          
          # Constr칩i a string de data e hora completa.
          full_datetime="$reformatted_date ${{ inputs.hora_local }}"
          
          # Usa o comando `date`, especificando o fuso hor치rio de entrada (TZ)
          # e pedindo a sa칤da em UTC (-u) no formato padr칚o ISO 8601.
          utc_time=$(TZ="${{ inputs.fuso_horario }}" date -d "$full_datetime" -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # Disponibiliza a vari치vel para os pr칩ximos steps.
          echo "utc_time=$utc_time" >> $GITHUB_OUTPUT

      - name: 2. Criar issue de agendamento com hor치rio em UTC
        uses: actions/github-script@v7
        with:
          script: |
            const utcTime = "${{ steps.convert_time.outputs.utc_time }}";
            const tag = "${{ inputs.tag }}";
            
            const issueBody = `**Tag para deploy:** ${tag}
            **Hor치rio agendado (UTC):** ${utcTime}
            
            Agendado via formul치rio com os seguintes dados locais:
            - **Data Local:** ${{ inputs.data_local }}
            - **Hora Local:** ${{ inputs.hora_local }}
            - **Fuso Hor치rio:** ${{ inputs.fuso_horario }}
            
            ---
            Este deploy ser치 executado automaticamente.
            
            <!--
            \`\`\`json
            {
              "tag": "${tag}",
              "schedule_time": "${utcTime}"
            }
            \`\`\`
            -->
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deploy agendado - ${tag}`,
              body: issueBody,
              labels: ['deploy-agendado']
            });
