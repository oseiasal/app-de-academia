name: Executar Deploys Agendados

on:
  workflow_dispatch:  # permite execu√ß√£o manual
  # schedule:
    # - cron: "*/10 * * * *"  # roda todos os dias √†s 20h no hor√°rio de Bras√≠lia (UTC-3)

permissions:
  issues: write  # üëà Permite criar e editar issues
  contents: write # Adicionado para permitir a cria√ß√£o de tags
  actions: write # Permite disparar outros workflows

jobs:
  processar:
    runs-on: ubuntu-latest
    steps:
      # O checkout agora precisa de fetch-depth: 0 para que o git tenha o hist√≥rico de tags
      - name: Baixar reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Processar issues com deploy agendado
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Buscando issues com label 'deploy-agendado'..."
          issues=$(gh issue list --label "deploy-agendado" --json number,body)

          if [ "$(echo "$issues" | jq 'length')" -eq 0 ]; then
            echo "‚úÖ Nenhum deploy agendado encontrado."
            exit 0
          fi

          echo "$issues" | jq -c '.[]' | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            body=$(echo "$issue" | jq -r '.body')

            json_block=$(echo "$body" | awk '/```json/{p=1;next} /```/{p=0} p')

            if [ -z "$json_block" ]; then
              echo "‚ö†Ô∏è Issue #$number: Nenhum bloco JSON encontrado no corpo. Pulando."
              continue
            fi

            tag=$(echo "$json_block" | jq -r '.tag // "null"')
            time=$(echo "$json_block" | jq -r '.schedule_time // "null"')

            if [ "$tag" = "null" ] || [ "$time" = "null" ]; then
              echo "‚ùå Issue #$number: Falha ao analisar tag ou schedule_time do bloco JSON. Pulando."
              echo "Bloco JSON encontrado:"
              echo "$json_block"
              continue
            fi

            now=$(date -u +%s)
            if ! end=$(date -d "$time" +%s 2>/dev/null); then
              echo "‚ùå Issue #$number: Formato de 'schedule_time' inv√°lido: $time. Pulando."
              continue
            fi

            echo "üïí Issue #$number ‚Üí Tag: $tag / Agendado para: $time"

            if [ $now -ge $end ]; then
              echo "‚úÖ Hora do deploy. Criando a tag '$tag'..."

              # Configura o Git com um usu√°rio bot
              git config user.name "GitHub Actions Bot"
              git config user.email "actions-bot@github.com"

              # Verifica se a tag j√° existe antes de tentar criar
              if git rev-parse "$tag" >/dev/null 2>&1; then
                  echo "‚ö†Ô∏è A tag $tag j√° existe. Pulando a cria√ß√£o, mas continuando com o deploy."
              else
                  # Cria a tag no commit mais recente (HEAD)
                  git tag "$tag"
                  # Empurra a nova tag para o reposit√≥rio remoto
                  git push origin "$tag"
                  echo "‚úÖ Tag $tag criada e enviada para o reposit√≥rio."
              fi

              echo "üöÄ Disparando deploy da tag $tag..."
              gh workflow run "Deploy Frontend Service - Dev" -f tag="$tag"
              gh issue close "$number" --comment "‚úÖ Tag '$tag' criada e deploy disparado automaticamente."
            else
              echo "‚è≥ Ainda n√£o √© hora do deploy (falta $((end - now)) segundos)."
            fi
          done
