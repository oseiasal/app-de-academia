name: Executar Deploys Agendados

on:
  workflow_dispatch:  # permite execuÃ§Ã£o manual
  schedule:
    - cron: "*/10 * * * *"  # roda todos os dias Ã s 20h no horÃ¡rio de BrasÃ­lia (UTC-3)

permissions:
  issues: write  # ğŸ‘ˆ Permite criar e editar issues
  contents: read # Leitura bÃ¡sica do repositÃ³rio
  actions: write # Permite disparar outros workflows

jobs:
  processar:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar repositÃ³rio
        uses: actions/checkout@v4

      - name: Processar issues com deploy agendado
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Buscando issues com label 'deploy-agendado'..."
          issues=$(gh issue list --label "deploy-agendado" --json number,title,body,state)

          if [ "$(echo $issues | jq length)" -eq 0 ]; then
            echo "âœ… Nenhum deploy agendado encontrado."
            exit 0
          fi

          echo "$issues" | jq -c '.[]' | while read issue; do
            number=$(echo $issue | jq -r '.number')
            tag=$(echo $issue | jq -r '.body' | grep "tag:" | awk '{print $2}')
            time=$(echo $issue | jq -r '.body' | grep "schedule_time:" | awk '{print $2}')

            now=$(date -u +%s)
            end=$(date -d "$time" +%s)

            echo "ğŸ•’ Issue #$number â†’ Tag: $tag / Agendado para: $time"

            if [ $now -ge $end ]; then
              echo "ğŸš€ Executando deploy da tag $tag..."
              gh workflow run "Deploy Frontend Service - Dev" -f tag="$tag"
              gh issue close "$number" -c "âœ… Deploy executado automaticamente."
            else
              echo "â³ Ainda nÃ£o Ã© hora do deploy (falta $((end - now)) segundos)."
            fi
          done
