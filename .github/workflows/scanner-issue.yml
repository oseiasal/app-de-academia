name: Executar Deploys Agendados

on:
  workflow_dispatch:  # permite execuÃ§Ã£o manual
  # schedule:
    # - cron: "*/10 * * * *"  # roda todos os dias Ã s 20h no horÃ¡rio de BrasÃ­lia (UTC-3)

permissions:
  issues: write  # ğŸ‘ˆ Permite criar e editar issues
  contents: read # Leitura bÃ¡sica do repositÃ³rio
  actions: write # Permite disparar outros workflows

jobs:
  processar:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar repositÃ³rio
        uses: actions/checkout@v4

      - name: Processar issues com deploy agendado
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Buscando issues com label 'deploy-agendado'..."
          issues=$(gh issue list --label "deploy-agendado" --json number,body)

          if [ "$(echo "$issues" | jq 'length')" -eq 0 ]; then
            echo "âœ… Nenhum deploy agendado encontrado."
            exit 0
          fi

          echo "$issues" | jq -c '.[]' | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            body=$(echo "$issue" | jq -r '.body')

            # Usa awk para extrair o conteÃºdo do bloco de cÃ³digo JSON de forma segura.
            # Ele comeÃ§a a imprimir apÃ³s a linha com ```json e para na prÃ³xima linha com ```.
            json_block=$(echo "$body" | awk '/```json/{p=1;next} /```/{p=0} p')

            if [ -z "$json_block" ]; then
              echo "âš ï¸ Issue #$number: Nenhum bloco JSON encontrado no corpo. Pulando."
              continue
            fi

            # Usa jq para extrair os dados. O '|| "null"' garante que a variÃ¡vel nÃ£o fique vazia.
            tag=$(echo "$json_block" | jq -r '.tag // "null"')
            time=$(echo "$json_block" | jq -r '.schedule_time // "null"')

            if [ "$tag" = "null" ] || [ "$time" = "null" ]; then
              echo "âŒ Issue #$number: Falha ao analisar tag ou schedule_time do bloco JSON. Pulando."
              echo "Bloco JSON encontrado:"
              echo "$json_block"
              continue
            fi

            now=$(date -u +%s)
            # Adiciona verificaÃ§Ã£o se a data Ã© vÃ¡lida antes de tentar converter
            if ! end=$(date -d "$time" +%s 2>/dev/null); then
              echo "âŒ Issue #$number: Formato de 'schedule_time' invÃ¡lido: $time. Pulando."
              continue
            fi

            echo "ğŸ•’ Issue #$number â†’ Tag: $tag / Agendado para: $time"

            if [ $now -ge $end ]; then
              echo "ğŸš€ Executando deploy da tag $tag..."
              gh workflow run "Deploy Frontend Service - Dev" -f tag="$tag"
              gh issue close "$number" --comment "âœ… Deploy executado automaticamente."
            else
              echo "â³ Ainda nÃ£o Ã© hora do deploy (falta $((end - now)) segundos)."
            fi
          done
